/* minified */
const countapi=require("countapi-js");async function getList({page:a,error:t}){let e,i=3;for(;0<i--;){e=[];try{await a.goto("https://fuli.gamer.com.tw/shop.php?page=1");let t=await a.$$("a.items-card");for(let a=t.length-1;0<=a;a--)await t[a].evaluate(a=>a.innerHTML.includes("æŠ½æŠ½æ¨‚"))&&e.push({name:await t[a].evaluate(a=>a.querySelector(".items-title").innerHTML),link:await t[a].evaluate(a=>a.href)});for(;await a.$eval("a.pagenow",a=>!!a.nextSibling);){await a.goto("https://fuli.gamer.com.tw/shop.php?page="+await a.$eval("a.pagenow",a=>a.nextSibling.innerText));let t=await a.$$("a.items-card");for(let a=t.length-1;0<=a;a--)await t[a].evaluate(a=>a.innerHTML.includes("æŠ½æŠ½æ¨‚"))&&e.push({name:await t[a].evaluate(a=>a.querySelector(".items-title").innerHTML),link:await t[a].evaluate(a=>a.href)})}break}catch(a){t(a)}}return e}async function checkInfo({page:a,log:t,error:e}){try{var i=await a.$eval("#name",a=>a.value),r=await a.$eval("#tel",a=>a.value),o=await a.$eval("[name=city]",a=>a.value),n=await a.$eval("[name=country]",a=>a.value),c=await a.$eval("#address",a=>a.value);if(i||t("ç„¡æ”¶ä»¶äººå§“å"),r||t("ç„¡æ”¶ä»¶äººé›»è©±"),o||t("ç„¡æ”¶ä»¶äººåŸŽå¸‚"),n||t("ç„¡æ”¶ä»¶äººå€åŸŸ"),c||t("ç„¡æ”¶ä»¶äººåœ°å€"),!(i&&r&&o&&n&&c))throw new Error("è­¦å‘Šï¼šæ”¶ä»¶äººè³‡æ–™ä¸å…¨")}catch(a){e(a)}}async function confirm({page:t,error:e}){try{await t.click("#agree-confirm"),await t.waitForSelector("#buyD > div.pbox-btn > a"),await t.waitForTimeout(100),await t.click("#buyD > div.pbox-btn > a"),await t.waitForSelector("#dialogify_1 > form > div > div > div.btn-box.text-right > button.btn.btn-insert.btn-primary"),await t.waitForTimeout(100),await Promise.all([t.waitForNavigation(),t.click("#dialogify_1 > form > div > div > div.btn-box.text-right > button.btn.btn-insert.btn-primary")]),await t.waitForTimeout(1e3)}catch(a){console.debug(t.url()),e(a)}}function report({lottery:a,unfinished:t}){let e="# ç¦åˆ©ç¤¾æŠ½æŠ½æ¨‚ \n\n";return a&&(e+=`âœ¨âœ¨âœ¨ ç²å¾— **${a}** å€‹æŠ½çŽæ©Ÿæœƒï¼Œåƒ¹å€¼ **${(500*a).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}** å·´å¹£ âœ¨âœ¨âœ¨
`),0===Object.keys(t).length&&(e+="ðŸŸ¢ æ‰€æœ‰æŠ½çŽçš†å·²å®Œæˆ\n"),Object.keys(t).forEach(a=>{void 0!==t[a]&&(e+=`âŒ æœªèƒ½è‡ªå‹•å®Œæˆæ‰€æœ‰ ***[${a}](${t[a]})*** çš„æŠ½çŽ
`)}),e+="\n",e}exports.parameters=[{name:"lottery_max_attempts",required:!1}],exports.run=async({page:i,outputs:r,params:a,logger:t})=>{const o=(...a)=>t.log("[95m[ç¦åˆ©ç¤¾][m",...a);var n=(...a)=>t.error("[95m[ç¦åˆ©ç¤¾][m",...a);if(!r.login||!r.login.success)throw new Error("ä½¿ç”¨è€…æœªç™»å…¥ï¼Œç„¡æ³•æŠ½çŽ");if(!r.ad_handler)throw new Error("éœ€ä½¿ç”¨ ad_handler æ¨¡çµ„");o("é–‹å§‹åŸ·è¡Œ");let c=0;o("æ­£åœ¨å°‹æ‰¾æŠ½æŠ½æ¨‚");const l=await getList({page:i,error:n});o(`æ‰¾åˆ° ${l.length} å€‹æŠ½æŠ½æ¨‚`);const w={};l.forEach(({name:a,link:t},e)=>{o(e+1+": "+a),w[a]=t});for(let e=0;e<l.length;e++){o(`æ­£åœ¨å˜—è©¦åŸ·è¡Œç¬¬ ${e+1} å€‹æŠ½æŠ½æ¨‚ï¼š `+l[e].name);var u=+a.lottery_max_attempts||30;for(let a=1;a<=u;a++){await i.goto(l[e].link).catch(n),await i.waitForSelector("#BH-master > .BH-lbox.fuli-pbox h1"),await i.waitForTimeout(100);var s,m=await i.$eval("#BH-master > .BH-lbox.fuli-pbox h1",a=>a.innerHTML);if(await i.$(".btn-base.c-accent-o.is-disable")){o(`ç¬¬ ${e+1} å€‹æŠ½æŠ½æ¨‚ï¼ˆ${l[e].name}ï¼‰çš„å»£å‘Šå…è²»æ¬¡æ•¸å·²ç”¨å®Œ [92mâœ”[m`),w[l[e].name]=void 0;break}o(`æ­£åœ¨åŸ·è¡Œç¬¬ ${a} æ¬¡æŠ½çŽï¼Œå¯èƒ½éœ€è¦å¤šé” 1 åˆ†é˜`),await i.click(".btn-base.c-accent-o").catch(n),await i.waitForTimeout(3e3),await i.$eval(".dialogify",a=>a.innerText.includes("å‹‡è€…å•ç­”è€ƒé©—")).catch(()=>{})&&(o("éœ€è¦å›žç­”å•é¡Œï¼Œæ­£åœ¨å›žç­”å•é¡Œ"),await i.$$eval("#dialogify_1 .dialogify__body a",a=>{a.forEach(a=>{a.dataset.option==a.dataset.answer&&a.click()})}),await i.waitForSelector("#btn-buy"),await i.waitForTimeout(100),await i.click("#btn-buy")),await i.waitForTimeout(5e3);let t=await i.$eval(".dialogify .dialogify__body p",a=>a.innerText).catch(()=>{})||"";if(t.includes("å»£å‘Šèƒ½é‡è£œå……ä¸­"))await n("å»£å‘Šèƒ½é‡è£œå……ä¸­"),await i.reload().catch(n);else{if(t.includes("è§€çœ‹å»£å‘Š")){o("æ­£åœ¨è§€çœ‹å»£å‘Š"),await i.click("button[type=submit].btn.btn-insert.btn-primary").catch(n),await i.waitForSelector("ins iframe").catch(n),await i.waitForTimeout(1e3);const d=await i.$("ins iframe").catch(n);try{s=await d.contentFrame(),await r.ad_handler({ad_frame:s})}catch(a){n(a)}await i.waitForTimeout(1e3)}else o(t);let a=i.url();a.includes("/buyD.php")&&a.includes("ad=1")?(o("æ­£åœ¨ç¢ºèªçµç®—é é¢"),await checkInfo({page:i,log:o,error:n}).catch(n),await confirm({page:i,error:n}).catch(n),await i.$(".card > .section > p")&&await i.$eval(".card > .section > p",a=>a.innerText.includes("æˆåŠŸ"))?(o("å·²å®Œæˆä¸€æ¬¡æŠ½æŠ½æ¨‚ï¼š"+m+" [92mâœ”[m"),c++):o("ç™¼ç”ŸéŒ¯èª¤ï¼Œé‡è©¦ä¸­ [91mâœ˜[m")):n("æœªé€²å…¥çµç®—é é¢ ("+a+")ï¼Œé‡è©¦ä¸­ [91mâœ˜[m")}}}return Object.keys(w).forEach(a=>void 0===w[a]&&delete w[a]),await i.waitForTimeout(2e3),o("åŸ·è¡Œå®Œç•¢ âœ¨"),c&&countapi.update("Bahamut-Automation","lottery",c),{lottery:c,unfinished:w,report:report}};